name: demo-crm CI/CD

on:
  push:
    branches:
      - main

jobs:
  CI:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Needed for auth action
    env:
      IMAGE_NAME: demo-crm
      IMAGE_TAG: v1.0.0
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      # IMAGE_NAME: demo-crm
      # PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      # PROJECT: 'demo-crm'
      # REPO: 'demo-crm-portfolio'
      # REGION: ${{ secrets.REGION }}
    timeout-minutes: 5
    defaults:
      run:
        working-directory: ./demo-crm
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Install dependencies and build
      - name: Install dependencies and build
        run: |
          npm install
          npm run build
          npm run dev &

      - name: Wait for server to start
        run: sleep 5

      # 3. Basic smoke test
      - name: Check application is running
        run: curl http://localhost:3000

      - name: Stop development server
        run: pkill -f "next dev" || echo "No process found"

      # 4. Docker build for testing
      - name: Build Docker image for local test
        run: docker build -t demo-crm:latest .

      # 5. Start Docker Compose for E2E tests
      - name: Start testing environment
        run: docker compose up -d

      - name: Wait for containers
        run: sleep 5

      - name: Verify containers are running
        run: |
          docker ps -a
          docker images

      # - name: Install Newman (Postman CLI)
      #   run: npm install -g newman

      # - name: Run Postman API tests
      #   run: |
      #     newman run ../tests/demo-crm.postman_collection.json \
      #       --environment ../tests/demo-crm.postman_environment.json \
      #       --reporters cli

      - name: Tear down testing environment
        run: docker compose down -v

      - name: Set up environment variables
        run: |
          echo "IMAGE_NAME_TAG=${REGION-docker.pkg.dev/$PROJECT/$REPO/$IMAGE_NAME}" >> $GITHUB_ENV

      # Step 2: Authenticate to GCP
      - name: Authenticate to Google Cloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          credentials_json: ${{ secrets.SERVICES_ACCOUNT_KEY }}
          export_default_credentials: true

        # Step 3: Configure Docker to use GCP credential helper
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io

      # Step 4: Build Docker image
      - name: Build Docker Image
        run: |
          docker build -t ${IMAGE_NAME} .

        # Step 5: Tag Docker image for GCR
      - name: Tag Docker Image for GCR
        run: |
          docker tag ${IMAGE_NAME} gcr.io/${PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}

        # Step 6: Push Docker image to GCR
      - name: Push Docker Image to GCR
        run: |
          docker push gcr.io/${PROJECT_ID}/${IMAGE_NAME}:${IMAGE_TAG}

      # # 6. GCP Auth & Push to GCR
      # - name: Authenticate to GCP
      #   uses: google-github-actions/setup-gcloud@v2
      #   with:
      #     credentials_json: ${{ secrets.SERVICES_ACCOUNT_KEY }}
      #     project_id: ${{ secrets.GCP_PROJECT_ID }}
      #     export_default_credentials: true

      # - name: Build Docker image
      #   run: docker build -t ${IMAGE_NAME}:latest .

      # - name: Configure Docker Client
      #   run: |-
      #     gcloud auth configure-docker --quiet

      # - name: Push Docker image to container registry (GCR)
      #   env:
      #     GIT_TAG: v1.0.0
      #   run: |
      #     docker tag ${IMAGE_NAME}:latest gcr.io/${{ secrets.GCP_PROJECT_ID }}/${IMAGE_NAME}:latest
      #     docker tag ${IMAGE_NAME}:latest gcr.io/${{ secrets.GCP_PROJECT_ID }}/${IMAGE_NAME}:${GIT_TAG}
      #     docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${IMAGE_NAME}:latest
      #     docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/${IMAGE_NAME}:${GIT_TAG}

  CD:
    needs: CI
    runs-on: ubuntu-latest
    timeout-minutes: 2
    defaults:
      run:
        working-directory: ./demo-crm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate to GCP
        uses: google-github-actions/setup-gcloud@v2
        with:
          credentials_json: ${{ secrets.SERVICES_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Update Kubernetes Deployment
        run: |
          gcloud container clusters get-credentials demo-crm-cluster --region ${{ secrets.GCP_REGION }} --project ${{ secrets.GCP_PROJECT_ID }}
          kubectl set image deployment/demo-crm-deployment demo-crm-container=gcr.io/${{ secrets.GCP_PROJECT_ID }}/demo-crm:v1.0.0
          kubectl rollout status deployment/demo-crm-deployment
          kubectl get pods
